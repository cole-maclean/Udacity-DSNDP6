<!DOCTYPE html>
<meta charset="utf-8">
<style>

text {
  font: 10px sans-serif;
}

</style>
<body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="http://thematicmapping.org/playground/d3/d3.slider/d3.slider.js"></script>
<script src="colorbrewer.js"></script>
<script src="d3.slider.js"></script>
<script>

function get_year(){
  return +d3.select(".handle").select("text").text()}

function get_discipline(){return 'cs'}


function discipline_selection(disciplines){
  var radius = 20
  var discipline_color = d3.scale.ordinal()
            .domain(disciplines)
            .range(colorbrewer.RdGy[10]);
  var discipline_node = discipline.selectAll(".node")
  .data(disciplines)
  .enter().append("g")
  .attr("transform", function(d, i) {return "translate(" + radius + "," + (i+1) * (radius*2+10) + ")";})

  discipline_node.append("circle")
  .attr("r", radius)
  .attr("fill", function(d){
        if (d==='cs'){
          return 'Red'
        } else {
          return 'Gray'
        }});

  discipline_node.append("text")
    .attr("x", 24)
    .attr("y", 9)
    .attr("dy", ".35em")
    .text(function(d) { return d; });
};

var margin = 75,
    width = 1400 - margin,
    height = 800 - margin;

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)

var page_title = svg.append("svg")
  .attr("width", width)
  .attr("height", height)
  .attr("class","page_title")
  .append("text")
  .attr("x", width/2)
  .attr("y", 10)
  .attr("dy", ".35em")
  .style("font-size", "20px")
  .style("text-decoration","underline")
  .style("text-anchor", "middle")
  .style("font-weight", "bold")
  .text("Growth of the Scientific Boundary");

var legend_title = svg.append("svg")
  .attr("width", 200)
  .attr("height", 200)
  .attr("class","legend_title")
  .append("text")
  .attr("x", 40)
  .attr("y", 9)
  .attr("dy", ".35em")
  .style("text-anchor", "middle")
  .style("font-weight", "bold")
  .text("Parent Category");

var discipline_title = svg.append("svg")
.attr("class","discipline_title")
.append("text")
.attr("x", width-75)
.attr("y", 9)
.attr("dy", ".35em")
.style("text-anchor", "middle")
.style("font-weight", "bold")
.text("Select Discipline");

var discipline= svg.append("svg")
  .attr("x",width - 100)
  .attr("class","discipline")

var legend = svg.append("svg")
  .attr("width", 200)
  .attr("height", height)
  .attr("class","legend")

var bubble_color = d3.scale.category20c();


function draw(data_model){

  function update(){

  year = get_year()
  discipline = get_discipline()

  category_ratio = data_model[year][discipline]['children'].length/data_model[2015][discipline]['children'].length

  var bubble = d3.layout.pack()
    .sort(null)
    .size([width*category_ratio, height*category_ratio])
    .padding(1.5)
    .value(function(d){return d.paper_count});

var bubble_svg = svg.append("svg")
    .attr("width", width*category_ratio)
    .attr("height", height*category_ratio)
    .attr("x",(width/2*(1-category_ratio)))
    .attr("y",(height/2*(1-category_ratio)))
    .attr("class", "bubble");

  d3.selectAll('.node').remove();
  d3.selectAll('.rect').remove();
  var legend_node = legend.selectAll(".node")
  .attr("class","node")
  .data(data_model[year][discipline]['parents']) 
  .enter().append("g")
  .attr("transform", function(d, i) {return "translate(0," + (i+1) * 20 + ")"; });

  legend_node.append("rect")
    .attr("class","node")
    .attr("width", 18)
    .attr("height", 18)
    .style("fill", function(d) {return bubble_color(d); });

  legend_node.append("text")
    .attr("class","node")
    .attr("x", 24)
    .attr("y", 9)
    .attr("dy", ".35em")
    .text(function(d) { return d; });

  var node = bubble_svg.selectAll(".node")
      .data(bubble.nodes(data_model[year][discipline])
      .filter(function(d) { return !d.children; }))
      .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

  node.append("title")
      .text(function(d) {
          return d.category + ": " + d.paper_count});

  node.append("circle")
      .attr("r", function(d) {
        return d.r; })
      .style("fill", function(d) {return bubble_color(d['parent_cat']); });

  node.append("text")
      .attr("dy", ".3em")
      .style("text-anchor", "middle")
      .text(function(d) { return d.paper_count; });

  }

var slider_width = width-400,
    startingValue = 2000;

// sets scale for slider
var x = d3.scale.linear()
    .domain([1999, 2015])
    .range([0, slider_width])
    .clamp(true);

// defines brush
var brush = d3.svg.brush()
    .x(x)
    .extent([startingValue, startingValue])
    .on("brush", brushed);

var svg_slider = svg.append("svg")
    .attr("width", width)
    .attr("x",200)
    .attr("y",-height/2+50)
  .append("g")

svg_slider.append("g")
    .attr("class", "x axis")
    // put in middle of screen
    .attr("transform", "translate(0," + height / 2 + ")")
    .attr("x",18)
    // inroduce axis
    .call(d3.svg.axis()
      .scale(x)
      .orient("bottom")
      .tickFormat(function(d) { return d; })
      .tickSize(0)
      .tickPadding(12)
      .tickValues([1999, 2015]))
  .select(".domain")
  .select(function() {console.log(this); return this.parentNode.appendChild(this.cloneNode(true)); })
    .attr("class", "halo");

var slider = svg_slider.append("g")
    .attr("class", "slider")
    .call(brush);

slider.selectAll(".extent,.resize")
    .remove();

slider.select(".background")
    .attr("height", height);

var handle = slider.append("g")
    .attr("class", "handle")

handle.append("path")
    .attr("transform", "translate(0," + height / 2 + ")")
    .attr("d", "M 0 -20 V 20")

handle.append('text')
  .text(startingValue)
  .attr("transform", "translate(" + (-18) + " ," + (height / 2 ) + ")");

slider
    .call(brush.event)

function brushed() {
  var value = brush.extent()[0];

  if (d3.event.sourceEvent) { // not a programmatic event
    handle.select('text');
    value = x.invert(d3.mouse(this)[0]);
    brush.extent([value, value])
  }
  handle.attr("transform", "translate(" + x(value) + ",0)");
  handle.select('text').text(Math.floor(value))
  update()
}

update()
};


d3.json("disciplines.json",discipline_selection);
d3.json("data_model.json",draw);
//d3.select(self.frameElement).style("height", diameter + "px");

</script>